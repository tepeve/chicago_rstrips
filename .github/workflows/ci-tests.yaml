name: CI Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Permitir ejecuci칩n manual

jobs:
  ci-tests:
    name: ci tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c칩digo del repo
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
      
      - name: 游냀 Configurar Python
        run: uv python install 3.11
      
      - name: 游닍 Instalar dependencias del sistema
        run: |
          uv sync
          
      - name: 游빍 Ejecutar tests
        run: |
          export PYTHONPATH=$PWD/src
          export WEATHER_API_KEY=dummy
          export SOCRATA_APP_TOKEN=dummy
          export POSTGRES_LOCAL_HOST=localhost
          export POSTGRES_LOCAL_PORT=5432
          export POSTGRES_LOCAL_USER=dummy
          export POSTGRES_LOCAL_PASSWORD=dummy
          export POSTGRES_LOCAL_DB=dummy
          uv run pytest -m "unit or ci" --cov=src/chicago_rstrips --cov-report=term-missing

          
  lint:
    name: Linting y Formateo
    runs-on: ubuntu-latest
    
    steps:
      - name: 游닌 Checkout c칩digo
        uses: actions/checkout@v4
      
      - name: 游냀 Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: 游닄 Instalar herramientas de linting
        run: |
          pip install ruff black isort
      
      - name: 游댌 Ejecutar Ruff (linter r치pido)
        run: |
          ruff check src/ tests/
        continue-on-error: true
      
      - name: 游꿛 Verificar formato con Black
        run: |
          black --check src/ tests/
        continue-on-error: true
      
      - name: 游닍 Verificar imports con isort
        run: |
          isort --check-only src/ tests/
        continue-on-error: true